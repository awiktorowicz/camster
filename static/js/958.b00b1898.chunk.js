(self.webpackChunkopencv_cam=self.webpackChunkopencv_cam||[]).push([[958],{175:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>P});var n=i(43),o=i(29),s=i.n(o),a=i(908),r=i(285),d=i.n(r),u=i(738);const c=(e,t,i)=>{const n=Math.round(t*(e.width/100)),o=Math.round(i*(e.height/100)),s=u.Fr?n/2:n/4,a=o/2,r=new(d().Point)(t/2-s,i/2-a),c=new(d().Point)(t/2+s,i/2-a),l=new(d().Point)(t/2-s,i/2+a);return[r,c,new(d().Point)(t/2+s,i/2+a),l]},l=(e,t)=>{d().rectangle(e,t[0],t[2],[255,255,255,255],2)};const h=class{constructor(e){var t=this;this.config=void 0,this.autoCaptureConfig=void 0,this.preprocessImage=function(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;d().cvtColor(e,i,d().COLOR_RGB2GRAY);let n=Math.max(3,Math.floor(Math.min(e.rows,e.cols)/100));d().GaussianBlur(e,i,new(d().Size)(n,n),0,0);let o=t.calculateIntensityThresholds(e);d().Canny(e,i,o[0],o[1]);let s=d().getStructuringElement(d().MORPH_ELLIPSE,new(d().Size)(5,5));d().morphologyEx(e,i,d().MORPH_CLOSE,s)},this.calculateIntensityThresholds=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.66,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1.33,n=d().mean(e)[0];return[t*n,i*n]},this.config=e.features.find((e=>"contour"===e.factoryName)),this.autoCaptureConfig=e}validate(e){return this.config.detectedContour=this.detectDocument(e),this.config.detectedContour?{isValid:!0}:{isValid:!1}}draw(e){if(!e||!this.config.detectedContour)return;let t=new(d().MatVector),i=d().matFromArray(this.config.detectedContour.length,1,d().CV_32SC2,this.config.detectedContour.flatMap((e=>[e.x,e.y])));t.push_back(i),d().polylines(e,t,this.config.draw.isClosed,this.config.draw.color,this.config.draw.thickness),i.delete(),t.delete()}getFeedback(e){return e?"Contour detected":'Position your "DOCUMENT" in the frame.'}updateConfig(e){e({...this.autoCaptureConfig.features.find((e=>"contour"===e.factoryName)),...this.config})}detectDocument(e){this.preprocessImage(e);return this.detectContours(e)}detectContours(e){let t=new(d().MatVector),i=new(d().Mat);d().findContours(e,t,i,d().RETR_EXTERNAL,d().CHAIN_APPROX_SIMPLE);let n=(e=>{var t,i,n,o,s,a,r,u;if(!e)return null;let c=[];const l=d().minAreaRect(e).center;let h,g,v,m,f=0,p=0,C=0,w=0;for(let d=0;d<e.data32S.length;d+=2){const t={x:e.data32S[d],y:e.data32S[d+1]},i=Math.hypot(t.x-l.x,t.y-l.y);t.x<l.x&&t.y<l.y?i>f&&(h=t,f=i):t.x>l.x&&t.y<l.y?i>p&&(g=t,p=i):t.x<l.x&&t.y>l.y?i>C&&(v=t,C=i):t.x>l.x&&t.y>l.y&&i>w&&(m=t,w=i)}return c.push(new(d().Point)(null===(t=h)||void 0===t?void 0:t.x,null===(i=h)||void 0===i?void 0:i.y)),c.push(new(d().Point)(null===(n=g)||void 0===n?void 0:n.x,null===(o=g)||void 0===o?void 0:o.y)),c.push(new(d().Point)(null===(s=m)||void 0===s?void 0:s.x,null===(a=m)||void 0===a?void 0:a.y)),c.push(new(d().Point)(null===(r=v)||void 0===r?void 0:r.x,null===(u=v)||void 0===u?void 0:u.y)),c})(this.findBiggestContour(t,this.config.minimumDetectableArea));return i.delete(),t.delete(),n}findBiggestContour(e,t){let i=t,n=null;for(let o=0;o<e.size();++o){let s=e.get(o),a=d().contourArea(s);if(a<t){s.delete();continue}let r=d().arcLength(s,!0),u=new(d().Mat);d().approxPolyDP(s,u,.02*r,!0),a>i&&this.isQuadrilateral(u)?(n&&n.delete(),n=u,i=a):u.delete(),s.delete()}return n}isQuadrilateral(e){return e&&4===e.rows}};const g=class{constructor(){this.config=void 0,this._detectedGlare=new(d().MatVector)}updateConfig(){throw new Error("Method not implemented.")}validate(e){let t=new(d().MatVector);return this._detectedGlare=this.detectGlare(e,t,240),this._detectedGlare?{isValid:!0,error:null}:{isValid:!1,error:"Glare Detected"}}draw(e){if(e&&this._detectedGlare)for(let t=0;t<this._detectedGlare.size();t++)d().drawContours(e,this._detectedGlare,t,new(d().Scalar)(0,0,255,255),2)}getFeedback(){throw new Error("Method not implemented.")}detectGlare(e,t,i){let n=new(d().Mat);d().cvtColor(e,n,d().COLOR_RGB2GRAY),d().threshold(n,e,i,255,d().THRESH_BINARY);let o=new(d().MatVector),s=new(d().Mat);d().findContours(e,o,s,d().RETR_EXTERNAL,d().CHAIN_APPROX_SIMPLE);for(let a=0;a<o.size();a++){let s=o.get(a);if(d().contourArea(s)>500){let r=d().Mat.zeros(e.rows,e.cols,d().CV_8UC1);d().drawContours(r,o,a,new(d().Scalar)(255),d().FILLED),d().mean(n,r)[0]>i&&t.push_back(s),r.delete()}s.delete()}return o.delete(),s.delete(),t}};var v=function(e){return e[e.Problem=0]="Problem",e[e.None=1]="None",e[e.ZoomIn=2]="ZoomIn",e[e.ZoomOut=3]="ZoomOut",e[e.MoveUp=4]="MoveUp",e[e.MoveDown=5]="MoveDown",e[e.MoveLeft=6]="MoveLeft",e[e.MoveRight=7]="MoveRight",e}(v||{});const m={contour:h,glare:g,position:class{constructor(e){this.autoCaptureConfig=void 0,this.contourDetectionConfig=void 0,this.config=void 0,this.zoomAction=void 0,this.guidanceBounds=void 0,this.detectedBounds=void 0,this.calculatePointLineDistances=(e,t)=>{if(!e||!t)return[];let i=[];return i.push(this.calculatePointLineDistance(e[0],t[0],t[3])),i.push(-this.calculatePointLineDistance(e[1],t[1],t[2])),i.push(-this.calculatePointLineDistance(e[2],t[1],t[2])),i.push(this.calculatePointLineDistance(e[3],t[0],t[3])),i},this.calculatePointLineDistance=(e,t,i)=>((i.y-t.y)*e.x-(i.x-t.x)*e.y+i.x*t.y-i.y*t.x)/Math.sqrt((i.y-t.y)**2+(i.x-t.x)**2),this.getBounds=e=>{if(!e)return null;return{minX:Math.min(...e.map((e=>e.x))),maxX:Math.max(...e.map((e=>e.x))),minY:Math.min(...e.map((e=>e.y))),maxY:Math.max(...e.map((e=>e.y)))}},this.autoCaptureConfig=e,this.contourDetectionConfig=this.autoCaptureConfig.features.find((e=>"contour"===e.factoryName)),this.zoomAction=v.Problem,this.guidanceBounds=this.getBounds(this.autoCaptureConfig.guidancePoints),this.detectedBounds=this.getBounds(this.contourDetectionConfig.detectedContour)}validate(e){const t=this.autoCaptureConfig.guidancePoints,i=this.autoCaptureConfig.features.find((e=>"contour"===e.factoryName)).detectedContour,n=this.autoCaptureConfig.validation.sideDetectionMargin;if(!t||!i)return{isValid:!1};const o=this.calculatePointLineDistances(i,t);let s=t[1].x-t[0].x;return o.every((e=>e<0))?(this.zoomAction=v.ZoomOut,{isValid:!1}):o.every((e=>e>=0))&&o.some((e=>e/s>n/100))?(this.zoomAction=v.ZoomIn,{isValid:!1}):this.detectedBounds&&this.guidanceBounds?this.detectedBounds.minX<this.guidanceBounds.minX?(this.zoomAction=v.MoveLeft,{isValid:!1}):this.detectedBounds.maxX>this.guidanceBounds.maxX?(this.zoomAction=v.MoveRight,{isValid:!1}):this.detectedBounds.minY<this.guidanceBounds.minY?(this.zoomAction=v.MoveUp,{isValid:!1}):this.detectedBounds.maxY>this.guidanceBounds.maxY?(this.zoomAction=v.MoveDown,{isValid:!1}):(this.zoomAction=v.None,{isValid:!0}):{isValid:!1}}draw(e){if(!e||!this.autoCaptureConfig.guidancePoints)return;const t=this.autoCaptureConfig.validation.sideDetectionMargin,i=(this.autoCaptureConfig.guidancePoints[1].x-this.autoCaptureConfig.guidancePoints[0].x)*t/100,n=new(d().Point)(this.autoCaptureConfig.guidancePoints[0].x+i,this.autoCaptureConfig.guidancePoints[0].y),o=new(d().Point)(this.autoCaptureConfig.guidancePoints[0].x+i,this.autoCaptureConfig.guidancePoints[3].y),s=new(d().Point)(this.autoCaptureConfig.guidancePoints[1].x-i,this.autoCaptureConfig.guidancePoints[0].y),a=new(d().Point)(this.autoCaptureConfig.guidancePoints[1].x-i,this.autoCaptureConfig.guidancePoints[3].y);d().line(e,n,o,new(d().Scalar)(0,255,0,255),2),d().line(e,s,a,new(d().Scalar)(0,255,0,255),2)}getFeedback(e){switch(this.zoomAction){case v.ZoomIn:return'Zoom in on the "DOCUMENT"';case v.ZoomOut:return'Zoom out of the "DOCUMENT"';case v.MoveLeft:return"Move the camera to the left";case v.MoveRight:return"Move the camera to the right";case v.MoveUp:return"Move the camera up";case v.MoveDown:return"Move the camera down";case v.None:return'"Document" in the correct position';case v.Problem:return"Problem with validation."}}updateConfig(e){}}},f=(e,t,i,n)=>{var o;if(null===e||void 0===e||null===(o=e.current)||void 0===o||!o.video)return[{type:"video",feedback:"Video not detected."}];e.current.video.width=e.current.video.videoWidth,e.current.video.height=e.current.video.videoHeight;const s=new(d().Mat)(e.current.video.height,e.current.video.width,d().CV_8UC4);new(d().VideoCapture)(e.current.video).read(s);let a=new(d().Mat)(e.current.video.height,e.current.video.width,d().CV_8UC4);t.current.getContext("2d").clearRect(0,0,1e3,1e3);const r=i.activeFeatures,u=[];r.forEach((e=>{let t=s.clone();const o=((e,t,i)=>{const n=m[e];if(!n)throw new Error(`Feature ${e} not found`);return new n(t,i)})(e,i,n),r=o.validate(t);t.delete(),o.updateConfig(n),i.debug&&o.draw(a),u.push({type:e,isValid:r.isValid,feedback:o.getFeedback(r.isValid)})})),d().imshow(t.current,a),s.delete(),a.delete(),i.detectionResults.splice(0,i.detectionResults.length,...u),n({autoCaptureConfig:i})};let p=function(e){return e[e.None=0]="None",e[e.Some=1]="Some",e[e.All=2]="All",e}({});class C{constructor(e,t){this.validationStatus=void 0,this.guidanceService=void 0,this.timeElapsed=void 0,this.timerId=void 0,this.autoCaptureConfig=void 0,this.isPictureTaken=void 0,this.validateFeatures=async e=>{const t=e.filter((e=>!e.isValid));switch(this.validationStatus=t.length===e.length?p.None:0===t.length?p.All:p.Some,this.validationStatus){case p.None:this.guidanceService.updateGuidanceWithDefaultMessage(),this.resetTimer();break;case p.Some:this.guidanceService.updateGuidanceWithInvalidFeedback(t[0].feedback),this.resetTimer();break;case p.All:this.isPictureTaken&&(await new Promise((e=>setTimeout(e,1500))),this.isPictureTaken=!1),this.guidanceService.updateGuidanceWithHoldSteadyMessage(),this.validatePositionContinously((()=>{this.guidanceService.updateGuidanceWithSuccessMessage(),this.isPictureTaken=!0}),(()=>this.guidanceService.updateGuidanceWithResetMessage()))}},this.validatePositionContinously=(e,t)=>{this.timerId||(this.timerId=window.setInterval((()=>{this.validationStatus===p.All?(this.timeElapsed+=100,console.log(this.timeElapsed),this.timeElapsed>=this.autoCaptureConfig.validation.holdingTime&&(this.resetTimer(),e())):(this.resetTimer(),t())}),100))},this.resetTimer=()=>{this.timerId&&(clearInterval(this.timerId),this.timerId=null),this.timeElapsed=0},this.autoCaptureConfig=e,this.validationStatus=p.None,this.guidanceService=t,this.timerId=null,this.timeElapsed=0,this.isPictureTaken=!1}}class w{constructor(e){this.defaultMessage=void 0,this.holdSteadyMessage=void 0,this.guideRef=void 0,this.updateGuidance=e=>{this.guideRef.current.innerText=e},this.updateGuidanceWithDefaultMessage=()=>{this.updateGuidance(this.defaultMessage)},this.updateGuidanceWithInvalidFeedback=e=>{this.updateGuidance(e)},this.updateGuidanceWithHoldSteadyMessage=()=>{this.updateGuidance(this.holdSteadyMessage)},this.updateGuidanceWithSuccessMessage=()=>{this.updateGuidance("Success, photo taken.")},this.updateGuidanceWithResetMessage=()=>{this.updateGuidance("Process of taking a picture got interrupted.")},this.guideRef=e,this.defaultMessage='Position your "DOCUMENT" in the frame',this.holdSteadyMessage="Hold steady to take a photo"}}class M extends Set{constructor(e){super(e);const t=[];for(let i of this)t.includes(i.name)?this.delete(i):t.push(i.name)}}const y=new class{constructor(){this.tasks=new M([]),this.fps=60,this.lastFrameTime=performance.now(),this.animationId=null,this.run=e=>{e-this.lastFrameTime>1e3/this.fps&&(this.tasks.forEach((t=>{e-t.lastFrameTime>1e3/t.fps&&(t.task(e),t.lastFrameTime=e)})),this.lastFrameTime=e),this.animationId=requestAnimationFrame(this.run)}}registerTask(e,t){this.tasks.add({task:e,fps:t,name:e.toString(),lastFrameTime:0}),1===this.tasks.size&&(this.animationId=requestAnimationFrame(this.run))}unregisterTask(e){this.tasks.delete(e),0===this.tasks.size&&null!==this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null)}};var x=i(579);const P=e=>{const[t,i]=(0,a.SF)(),o=n.useRef(null),r=n.useRef(null),h=n.useRef(null),g=(0,n.useRef)(null),v=(0,n.useRef)(null),m=n.useRef(null),p=n.useRef(null),M=(()=>{let e={facingMode:{exact:"user"},width:{ideal:1280},height:{ideal:720}};return u.Fr&&(e={facingMode:{exact:"environment"},width:{ideal:window.innerHeight},height:{ideal:window.screen.width}}),e})(),P=()=>{((e,t,i,n)=>{var o;const s=null===e||void 0===e||null===(o=e.current)||void 0===o?void 0:o.video,a=t.current;a.width=s.videoWidth,a.height=s.videoHeight;const r=i.current;r.style.width=`${s.videoWidth}px`,r.style.height=`${s.videoHeight}px`,n.guidancePoints=c(n.detectionFrame,a.width,a.height)})(h,g,r,t.autoCapture)},S=()=>{((e,t,i)=>{var n;const o=null===e||void 0===e||null===(n=e.current)||void 0===n?void 0:n.getCanvas();if(o){t.current.getContext("2d",{willReadFrequently:!0}).drawImage(e.current.video,0,0,o.width,o.height);const n=d().imread(t.current);i.guidancePoints&&l(n,i.guidancePoints),d().imshow(t.current,n),n.delete()}})(h,g,t.autoCapture)},k=new w(m),R=new C(t.autoCapture,k),T=()=>{R.validateFeatures(t.autoCapture.detectionResults)};return(0,x.jsxs)("div",{children:[(0,x.jsxs)("div",{style:{position:"relative"},children:[(0,x.jsx)("div",{ref:o,children:(0,x.jsx)(s(),{videoConstraints:M,ref:h,onUserMedia:()=>{setTimeout((()=>{P(),y.registerTask(S,60),y.registerTask((()=>f(h,v,t.autoCapture,i)),20),y.registerTask(T,10)}),2e3)},style:{position:"absolute"}})}),(0,x.jsxs)("div",{ref:r,style:{position:"relative"},children:[(0,x.jsx)("canvas",{id:"canvasOutput",ref:g,style:{position:"absolute"}}),(0,x.jsx)("canvas",{id:"canvasDebug",ref:v,style:{position:"absolute"}}),(0,x.jsx)("div",{ref:m,id:"guidance",style:{position:"absolute",color:"white",textAlign:"center",bottom:"40px",width:"100%"},children:"Position document inside boundary"}),(0,x.jsx)("div",{ref:p,role:"alert",style:{clipPath:"inset(50%)",height:"1px",overflow:"hidden",position:"absolute",whiteSpace:"nowrap",width:"1px"},children:"Position document inside boundary"})]})]}),(0,x.jsx)("div",{style:{position:"relative"},children:(0,x.jsx)("a",{href:"/camster",children:"Back to settings"})})]})}},392:()=>{},562:()=>{},90:()=>{}}]);
//# sourceMappingURL=958.b00b1898.chunk.js.map